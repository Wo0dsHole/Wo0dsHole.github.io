<!DOCTYPE html>
<html lang="en-us">
  <head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noodp"/>
  <meta name="author" content="Wo0dsHole">
  
  
  
  <link rel="prev" href="https://Wo0dsHole.github.io/2000/2000/" />
  <link rel="next" href="https://Wo0dsHole.github.io/2001/2001/" />
  <link rel="canonical" href="https://Wo0dsHole.github.io/2000/b1/" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>
       
       
           垃圾回收 | 树洞
       
  </title>
  <meta name="title" content="垃圾回收 | 树洞">
    
  
  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/css/main.min.css">


  
  
 

<script type="application/ld+json">
 "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https:\/\/Wo0dsHole.github.io\/"
    },
    "articleSection" : "posts",
    "name" : "垃圾回收",
    "headline" : "垃圾回收",
    "description" : "GC [TOC]\nlearn from 《垃圾回收算法与实现》\n勘误表链接：http:\/\/www.ituring.com.cn\/book\/1460\nAim  GC基础：3种算法本身、保守式\u0026amp;准确式、衡量指标、 指标取舍：从“GC基础”出发，尤其是衡量指标角度，去领悟更多 GC算法的内在道理（如何在指标间权衡） 实践实现：minigc 学习实践分析：v8 尝试分析：现在的 v8 （实践自己的学习方法）  2019\/4\/23\n前言 GC = 虚拟内存\n两部分结构，感受实现与理论的细节差异\n理解解释器可从一点深挖，自然会波及整体\nGC不过时，现在计算机结构的设计中：空间虚拟存储的支持\n序言 垃圾 = 程序不用的内存空间\n垃圾回收 = 找到垃圾 \u0026amp; 使可再次利用（回收）\n意义：内存bug的复杂性——依托于环境。故需要GC来解决一类问题\n3中GC算法\n编程中对内存空间的留意（理解）\n书中符号约定，主要是箭头需要额外记忆\n知识基础：c的函数指针、c\u002b\u002b模板\nGC基本概念 书中约定 域：1个字\n指针：算法篇，均可识别 \u0026amp; 指针指向对象首地址\nchildren：子对象指针数组\n堆：大小固定 HEAP_SIZE \u0026amp; 左低右高\nallocation_fail()：基于约定不扩大堆，故销毁计算结果，报错\n \u002b------\u002b------\u002b------\u002b\r| | | |\rA | \u002b | \u002b | |\r| | | | | |\r\u002b------\u002b------\u002b------\u002b\r| |\r| |\rv \u002b-----\u0026gt;\u002b------\u002b\r\u002b-------\u002b | |\r| | C | |\rB | | \u002b------\u002b\r\u002b-------\u002b\r对象：头、域  object\r\u002b---------\u002b-----------------\u002b\r| | |\r| header | body |\r| | |\r\u002b---------\u002b-----------------\u002b\rkey：header的对外隐藏",
    "inLanguage" : "en-us",
    "author" : "Wo0dsHole",
    "creator" : "Wo0dsHole",
    "publisher": "Wo0dsHole",
    "accountablePerson" : "Wo0dsHole",
    "copyrightHolder" : "Wo0dsHole",
    "copyrightYear" : "2000",
    "datePublished": "2000-03-14 00:00:00 \u002b0800 CST",
    "dateModified" : "2000-03-14 00:00:00 \u002b0800 CST",
    "url" : "https:\/\/Wo0dsHole.github.io\/2000\/b1\/",
    "wordCount" : "240",
    "keywords" : [ "垃圾回收", "树洞"]
}
</script>

</head>

  


  <body class="">
    <div class="wrapper">
        <nav class="navbar">
    <div class="container">
        <div class="navbar-header header-logo">
        	<a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://Wo0dsHole.github.io/">树洞</a>
        </div>
        <div class="menu navbar-right">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
     <div class="container">
        <div class="navbar-header">
            <div>  <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://Wo0dsHole.github.io/">树洞</a></div>
            <div class="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
        </div>
    </div>
</nav>
    	 <main class="main">
          <div class="container">
      		
<article class="post-warp" itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">垃圾回收</h1>
        <div class="post-meta">
                Written by <a itemprop="name" href="https://Wo0dsHole.github.io/" rel="author">Wo0dsHole</a> with ♥ 
                <span class="post-time">
                on <time datetime=2000-03-14 itemprop="datePublished">March 14, 2000</time>
                </span>
                in
                
        </div>
    </header>
    <div class="post-content">
        

        

        
        
     
          
          
          

          
          
          

          <h1 id="gc">GC</h1>
<p>[TOC]</p>
<p>learn from 《垃圾回收算法与实现》</p>
<p>勘误表链接：http://www.ituring.com.cn/book/1460</p>
<h2 id="aim">Aim</h2>
<ul>
<li>GC基础：3种算法本身、保守式&amp;准确式、衡量指标、</li>
<li>指标取舍：从“GC基础”出发，尤其是衡量指标角度，去领悟更多 GC算法的内在道理（如何在指标间权衡）</li>
<li>实践实现：minigc</li>
<li>学习实践分析：v8</li>
<li>尝试分析：现在的 v8</li>
<li>（实践自己的学习方法）</li>
</ul>
<p>2019/4/23</p>
<h2 id="前言">前言</h2>
<p>GC = 虚拟内存</p>
<p>两部分结构，感受实现与理论的细节差异</p>
<p>理解解释器可从一点深挖，自然会波及整体</p>
<p>GC不过时，现在计算机结构的设计中：空间虚拟存储的支持</p>
<h2 id="序言">序言</h2>
<p>垃圾 = 程序不用的内存空间</p>
<p>垃圾回收 = 找到垃圾 &amp; 使可再次利用（回收）</p>
<p>意义：内存bug的复杂性——依托于环境。故需要GC来解决一类问题</p>
<p>3中GC算法</p>
<p>编程中对内存空间的留意（理解）</p>
<p>书中符号约定，主要是箭头需要额外记忆</p>
<p>知识基础：c的函数指针、c++模板</p>
<h2 id="gc基本概念">GC基本概念</h2>
<h3 id="书中约定">书中约定</h3>
<p>域：1个字</p>
<p>指针：算法篇，均可识别 &amp; 指针指向对象首地址</p>
<p>children：子对象指针数组</p>
<p>堆：大小固定 HEAP_SIZE &amp; 左低右高</p>
<p>allocation_fail()：基于约定不扩大堆，故销毁计算结果，报错</p>
<pre><code>   +------+------+------+
   |      |      |      |
A  |  +   |  +   |      |
   |  |   |  |   |      |
   +------+------+------+
      |      |
      |      |
      v      +-----&gt;+------+
      +-------+     |      |
      |       |   C |      |
    B |       |     +------+
      +-------+

</code></pre><h3 id="对象头域">对象：头、域</h3>
<pre><code>        object
+---------+-----------------+
|         |                 |
|  header |      body       |
|         |                 |
+---------+-----------------+

</code></pre><p>key：header的对外隐藏</p>
<h3 id="mutator">mutator</h3>
<p>抽象描述</p>
<p>实体：</p>
<ul>
<li>应用程序</li>
</ul>
<p>操作：</p>
<ul>
<li>生成对象</li>
<li>更新指针</li>
</ul>
<p>mutator-&gt;对象关系变化-&gt;垃圾产生 &lt;-GC</p>
<h3 id="堆">堆</h3>
<p>GC仍不能解决 -&gt; 堆扩大</p>
<h3 id="活动非活动对象">活动/非活动对象</h3>
<p>mutator自引用去寻找 -&gt; 无法死而复活</p>
<p>实际GC角度界定“垃圾”</p>
<h3 id="分块">分块</h3>
<p>chunk：为利用对象事先准备的空间（不是强调分割）</p>
<h3 id="根">根</h3>
<p>对象引用树</p>
<p>可被mutator直接引用：调用栈、寄存器、全局变量</p>
<h3 id="评价标准">评价标准</h3>
<p>其实就是时间、空间两方面。</p>
<ol>
<li>吞吐量：单位时间的处理能力（堆大小）。ps：具体mutator动作相关</li>
<li>最大暂停时间：单次处理可能耗时上限</li>
<li>堆使用效率：头大小（管理信息）、堆的用法</li>
<li>访问的局部性：存储体系、引用的连续性、对象重排</li>
</ol>
<h2 id="标记-清除算法">标记-清除算法</h2>
<p>从2012年起，所有浏览器都使用标记-清除算法。</p>
<h3 id="算法本身">算法本身</h3>
<h4 id="标记">标记</h4>
<p>所有<strong>活动对象的遍历</strong>（正比活动对象数）</p>
<p>注意2点：</p>
<ol>
<li>根也要判断是否已标记：对象树不完全是树结构，可能有回调。对根不先判断标记，就会重复。</li>
<li>搜索方式：深度优先使用内存更少
<ul>
<li>深度优先：保留一条深度节点 + 回溯</li>
<li>广度优先：保留一层节点</li>
</ul>
</li>
</ol>
<h4 id="清除">清除</h4>
<p>整个<strong>堆的遍历</strong>（正比堆大小）</p>
<ul>
<li>对于已标记的，取消标记</li>
<li>对于未标记的，重写其域(.next)，并入空闲链</li>
</ul>
<p>注意：</p>
<ol>
<li>这里的遍历方式似乎默认了对象的紧凑排列，不然指针的移动不会是 + sweeping.size。那么也就是隐含了初始堆的全空白、连续的分配方式，以及GC后的压缩要求。</li>
<li>判断垃圾后，重写域的“不当人”的方式，在漏洞利用中可以想想。</li>
<li>若1中后续推测正确，那么GC被打断会不会出问题？如何避免？</li>
</ol>
<h4 id="分配">分配</h4>
<p>这里的分配是GC后的内存再使用，没有解答我上面的推测。</p>
<ul>
<li>First-fit：第一个可用（time更优）</li>
<li>Best-fit：可用且最适</li>
<li>Worst-fit：最大分割（不推荐）</li>
</ul>
<h4 id="合并">合并</h4>
<p>合并发生在清除阶段，依赖于清除时对堆的线性遍历特点。</p>
<p>即满足<code>sweeping==$free_list+$free_list.size</code>时，可判断其空间相邻性</p>
<p>但还是没有解答我上面的推测。我自己的解答是这样的：</p>
<p><em>这里的所有对象header中size的偏移一样，且free_list的size偏移也是。而非活动对象GC后数据并没有回收，对待非活动对象，不仅是重写<code>next</code>，还有重读<code>size</code>。以此识别之前GC后“空洞”的大小，继续遍历堆空间。分配方式也确实是连续的，First-fit。</em></p>
<h4 id="优点">优点</h4>
<ul>
<li>实现简单，组合其他算法方便</li>
<li>兼容保守式GC（对象不移动）</li>
</ul>
<h4 id="缺点">缺点</h4>
<ul>
<li>碎片化：因为优点2，对象不移动导致</li>
<li>分配速度：空闲空间的逻辑连续，需遍历链表（尤其是碎片严重之后，time更长）</li>
<li>与写时复制不兼容：os中的内存共享机制，但共享的前提是相同，标记-清除的小改动影响了整体。</li>
<li>标记、清除阶段本身导致的暂停时间（两次全遍历确实感觉有不足）</li>
</ul>
<h3 id="指标权衡">指标权衡</h3>
<h4 id="多个空闲链表--v">多个空闲链表 —— v</h4>
<p>根据实际情况，按特定大小准备空闲链表，对于实际中极少数情况（超出上限大小的分配），仍用单一空闲链表。</p>
<h4 id="bibop法--p">BiBOP法 —— p</h4>
<p>Big Bag Of Pages</p>
<p>碎片产生是由于同一堆空间中，对象大小的差异和生存周期不一。碎片是“差值”。</p>
<p>将堆分为不同的块，每个块中对象大小一致，对于实际对象冗余处理以对应这些预设大小。</p>
<p>这使得“差值”为0。</p>
<p>但这明显有冗余，不仅是对象的冗余处理，还有堆的预先划分。</p>
<p>基本上就是“多空闲链表”的“数组”版本（静态的）。</p>
<p>处理碎片化的同时，却导致了堆使用率的问题，感觉本末倒置，有些蠢。</p>
<h4 id="位图标记--wot">位图标记 —— wot、%</h4>
<p>将标志位抽离到“私有空间”，以位图表格的形式管理，而“公有空间”中不变的对象可继续共享。</p>
<p>（这种私有信息如果可以通信传递，那么可能出问题，破坏共享的基础——不变）</p>
<p>需要解决两个问题：</p>
<ul>
<li>位图和对象的对应：对象编号<code>(obj-$heap_start)/WORD_LENGTH</code></li>
<li>位图和堆空间的对应：这里的对应是为了GC，而对象编号基于首地址，可逆运算出。GC只需要对象首地址、固定的size偏移处原data。</li>
</ul>
<p>位图的构建方式（很多）满足上两点即可：<code>index = obj_num / WORD_LENGTH</code>、<code>offset = obj_num % WORD_LENGTH</code></p>
<p>优点：</p>
<ul>
<li>兼容写时复制（Linux）</li>
<li>标记、清除更高效</li>
</ul>
<p>（以额外的小空间为代价，1字对应1位。其实也不算太小。）</p>
<p>注意：</p>
<ul>
<li>一般是一个堆对应一个位图表格</li>
</ul>
<h4 id="延迟清除法--s">延迟清除法 —— s</h4>
<p>“按需清除”：</p>
<ul>
<li>分配时第一次 lazy_sweep(size) = 清除标记 + 未GC前有无可分配内存</li>
<li>mark()，标记阶段</li>
<li>第二次 lazy_sweep(size) = GC + 看有无可分配内存</li>
</ul>
<p>注意：</p>
<p>这里对清除阶段的延迟，不是延迟到任何下一次分配，而是无可奈何遍历到垃圾对象时的分配。</p>
<p>也就是清除阶段对堆的变量是“按需”的，找到满足分配即可，不全部遍历。故缩短最大暂停时间。</p>
<p>缺点：</p>
<ul>
<li>按需遍历导致垃圾分部不均：在垃圾堆更快获得分开，在活动对象对则反之。</li>
</ul>
<h2 id="引用计数">引用计数</h2>
<p>其实我关注浏览器，可以先不看这部分。</p>
<h2 id="gc复制算法">GC复制算法</h2>
<p>其实我关注浏览器，可以先不看这部分。但标记-压缩算法涉及到了，所以就看看此算法本身吧，不看延伸算法。</p>
<h2 id="标记-压缩算法">标记-压缩算法</h2>

    </div>

    <div class="post-copyright">
             
            <p class="copyright-item">
                <span>Author:</span>
                <span>Wo0dsHole </span>
                </p>
            
           
             
            <p class="copyright-item">
                    <span>Link:</span>
                    <a href=https://Wo0dsHole.github.io/2000/b1/>https://Wo0dsHole.github.io/2000/b1/</span>
            </p>
            
             
            <p class="copyright-item lincese">
                本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可
            </p>
            
    </div>

  
    <div class="post-tags">
        
            <section>
            <i class="iconfont icon-tag"></i>Tag(s): 
            
            <span class="tag"><a href="https://Wo0dsHole.github.io/tags/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/">
                    #垃圾回收</a></span>
            
            </section>
        
        <section>
                <a href="javascript:window.history.back();">back</a></span> · 
                <span><a href="https://Wo0dsHole.github.io/">home</a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="https://Wo0dsHole.github.io/2000/2000/" class="prev" rel="prev" title="2000-书法"><i class="iconfont icon-left"></i>&nbsp;2000-书法</a>
         
        
        <a href="https://Wo0dsHole.github.io/2001/2001/" class="next" rel="next" title="2001-方法论">2001-方法论&nbsp;<i class="iconfont icon-right"></i></a>
        
    </div>

    <div class="post-comment">
          
                 
          
    </div>
</article>
          </div>
		   </main>
      <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">1993 - 2020</span>
        
        <span class="with-love">
    	 <i class="iconfont icon-love"></i> 
         </span>
         
            <span class="author" itemprop="copyrightHolder"><a href="https://Wo0dsHole.github.io/">Wo0dsHole</a> | </span> 
         

         
		  <span>Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow">Hugo</a> & <a href="https://github.com/liuzc/leaveit" target="_blank" rel="external nofollow">LeaveIt</a></span> 
    </div>
</footer>












    
    
    <script src="/js/vendor_no_gallery.min.js" async=""></script>
    
  



     </div>
  </body>
</html>
